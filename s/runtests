#!/bin/bash
set -euo pipefail

eval "$(luarocks path)"
ROOT=$(git rev-parse --show-toplevel)
export LUA_PATH="$ROOT/scripts/?.lua;$LUA_PATH"
BUILD="$ROOT/build"

function run_test() {
	if [ "$1" = "-V" ]; then
		shift 1
		SUPP="$ROOT/share/ubuntu-12_04.supp"
		valgrind --quiet --suppressions="$SUPP" --error-exitcode=1 --leak-check=no "$@"
	else
		shift 1
		"$@"
	fi
}

TEST_EXEC="$BUILD/eressea/test_eressea"
ERESSEA_EXEC="$BUILD/eressea/eressea"
VAL=''
if [[ -n "${1+x}" && "$1" = "-V" ]]; then
	VAL='-V'
fi

cd "$ROOT/tests"
run_test "$VAL" "$TEST_EXEC"
run_test "$VAL" "$ERESSEA_EXEC" -v1 ../scripts/run-tests.lua
run_test "$VAL" "$ERESSEA_EXEC" -v1 ../scripts/run-tests-e2.lua
run_test "$VAL" "$ERESSEA_EXEC" -v1 ../scripts/run-tests-e3.lua
"$ERESSEA_EXEC" --version
rm -rf reports orders.txt score score.alliances datum turn

cd "$OLDPWD"
